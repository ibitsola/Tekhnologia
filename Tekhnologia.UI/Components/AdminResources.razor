@using Microsoft.AspNetCore.Components
@rendermode RenderMode.InteractiveServer

@using System.Net.Http.Json
@using Tekhnologia.Models.DTOs
@using Tekhnologia.Models
@using Tekhnologia.Services.Interfaces
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Components.Web
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@inject IDigitalResourceService DigitalResourceService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation

<div class="section">
    <h2 class="title">Resource Management</h2>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="notification is-danger">
            <button class="delete" @onclick="() => errorMessage = null"></button>
            @errorMessage
        </div>
    }

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="notification is-success">
            <button class="delete" @onclick="() => successMessage = null"></button>
            @successMessage
        </div>
    }

    <div class="level">
        <div class="level-left">
            <div class="level-item">
                <h2 class="subtitle">All Resources</h2>
            </div>
        </div>
        <div class="level-right">
            <div class="level-item">
                <button class="button user-role-tag" @onclick="ShowAddModal">+ Add Resource</button>
            </div>
        </div>
    </div>

    @if (loading)
    {
        <p class="has-text-grey-light">Loading resources...</p>
    }
    else if (resources == null || !resources.Any())
    {
        <div class="box">
            <p class="has-text-grey-light has-text-centered" style="padding: 2rem;">No resources yet. Add your first resource above.</p>
        </div>
    }
    else
    {
                    <div class="box">
                        <table class="table is-fullwidth is-striped is-hoverable">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Category</th>
                                    <th>Type</th>
                                    <th>Price</th>
                                    <th>Uploaded</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var r in resources)
                                {
                                    <tr>
                                        <td>@r.Title</td>
                                        <td>
                                            <span class="tag">@r.Category</span>
                                        </td>
                                        <td>@r.FileType</td>
                                        <td>
                                            @if (r.IsFree)
                                            {
                                                <span class="tag user-role-tag">Free</span>
                                            }
                                            else
                                            {
                                                <span class="tag admin-role-tag">Â£@r.Price?.ToString("F2")</span>
                                            }
                                        </td>
                                        <td>@r.UploadDate.ToString("MMM dd, yyyy")</td>
                                        <td>
                                            <div class="buttons are-small">
                                                <button class="button admin-action-btn" @onclick="() => ShowEditModal(r)">Edit</button>
                                                <button class="button admin-action-btn" @onclick="() => ShowDeleteConfirm(r)">Delete</button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                    </table>
                </div>
            }

    <!-- Add/Edit Modal -->
        @if (showModal)
        {
            <div class="modal is-active">
                <div class="modal-background" @onclick="CloseModal"></div>
                <div class="modal-card">
                    <header class="modal-card-head">
                        <p class="modal-card-title">@(isEditMode ? "Edit Resource" : "Add Resource")</p>
                        <button class="delete" aria-label="close" @onclick="CloseModal"></button>
                    </header>
                    <section class="modal-card-body">
                        <EditForm Model="@resourceForm" OnValidSubmit="@SaveResource">
                            <div class="field">
                                <label class="label">Title</label>
                                <div class="control">
                                    <input class="input" @bind="resourceForm.Title" required />
                                </div>
                            </div>

                            <div class="field">
                                <label class="label">Category</label>
                                <div class="control">
                                    <div class="select is-fullwidth">
                                        <select @bind="resourceForm.Category">
                                            <option value="">-- Select Category --</option>
                                            <option value="Books">Books</option>
                                            <option value="Images">Images</option>
                                            <option value="Courses">Courses</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            @if (resourceForm.Category == "Courses")
                            {
                                <div class="field">
                                    <label class="label">External URL</label>
                                    <div class="control">
                                        <input class="input" type="url" @bind="resourceForm.ExternalUrl" placeholder="https://..." />
                                    </div>
                                    <p class="help">External course link (e.g., Udemy, Coursera)</p>
                                </div>
                                <div class="field">
                                    <label class="label">Upload Thumbnail/Image</label>
                                    <div class="control">
                                        <InputFile OnChange="OnFileSelected" />
                                    </div>
                                    <p class="help">Upload a thumbnail or course image</p>
                                </div>
                            }
                            else
                            {
                                <div class="field">
                                    <label class="label">Upload File</label>
                                    <div class="control">
                                        <InputFile OnChange="OnFileSelected" />
                                    </div>
                                    @if (!string.IsNullOrEmpty(resourceForm.FilePath))
                                    {
                                        <p class="help">Current file: @Path.GetFileName(resourceForm.FilePath)</p>
                                    }
                                </div>
                            }

                            <div class="field">
                                <label class="label">Thumbnail URL (optional)</label>
                                <div class="control">
                                    <input class="input" type="url" @bind="resourceForm.ThumbnailUrl" placeholder="https://..." />
                                </div>
                            </div>

                            <div class="field">
                                <label class="label">Price</label>
                                <div class="control">
                                    <input class="input" type="number" step="0.01" @bind="resourceForm.Price" placeholder="0.00 (Free if empty)" />
                                </div>
                            </div>

                            <div class="field">
                                <div class="control">
                                    <label class="checkbox">
                                        <input type="checkbox" @bind="resourceForm.IsFree" />
                                        Free Resource
                                    </label>
                                </div>
                            </div>

                            <div class="field is-grouped is-grouped-right">
                                <div class="control">
                                    <button type="submit" class="button user-role-tag" disabled="@isSaving">
                                        @(isSaving ? "Saving..." : "Save")
                                    </button>
                                </div>
                                <div class="control">
                                    <button type="button" class="button" @onclick="CloseModal">Cancel</button>
                                </div>
                            </div>
                        </EditForm>
                    </section>
                </div>
            </div>
        }

        <!-- Delete Confirmation Modal -->
        @if (showDeleteModal && resourceToDelete != null)
        {
            <div class="modal is-active">
                <div class="modal-background" @onclick="CloseModal"></div>
                <div class="modal-card">
                    <header class="modal-card-head">
                        <p class="modal-card-title">Confirm Deletion</p>
                        <button class="delete" aria-label="close" @onclick="CloseModal"></button>
                    </header>
                    <section class="modal-card-body">
                        <p>Are you sure you want to delete <strong>@resourceToDelete.Title</strong>?</p>
                        <p class="has-text-danger">This action cannot be undone!</p>
                    </section>
                    <footer class="modal-card-foot">
                        <button class="button is-danger" @onclick="ConfirmDelete" disabled="@isDeleting">
                            @(isDeleting ? "Deleting..." : "Delete")
                        </button>
                        <button class="button" @onclick="CloseModal">Cancel</button>
                    </footer>
                </div>
            </div>
        }
</div>

@code {
    private List<DigitalResourceDTO>? resources;
    private DigitalResourceDTO resourceForm = new();
    private DigitalResourceDTO? resourceToDelete;
    private IBrowserFile? selectedFile;
    private bool loading = true;
    private bool showModal = false;
    private bool showDeleteModal = false;
    private bool isEditMode = false;
    private bool isSaving = false;
    private bool isDeleting = false;
    private string? errorMessage;
    private string? successMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadResources();
    }

    private async Task LoadResources()
    {
        try
        {
            loading = true;
            resources = DigitalResourceService.GetAllResources(null, null);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading resources: {ex.Message}";
        }
        finally
        {
            loading = false;
        }
    }

    private void ShowAddModal()
    {
        isEditMode = false;
        resourceForm = new DigitalResourceDTO { IsFree = true };
        selectedFile = null;
        showModal = true;
    }

    private void ShowEditModal(DigitalResourceDTO resource)
    {
        isEditMode = true;
        resourceForm = new DigitalResourceDTO
        {
            Id = resource.Id,
            Title = resource.Title,
            Category = resource.Category,
            FileType = resource.FileType,
            FilePath = resource.FilePath,
            ThumbnailUrl = resource.ThumbnailUrl,
            ExternalUrl = resource.ExternalUrl,
            IsFree = resource.IsFree,
            Price = resource.Price
        };
        selectedFile = null;
        showModal = true;
    }

    private void ShowDeleteConfirm(DigitalResourceDTO resource)
    {
        resourceToDelete = resource;
        showDeleteModal = true;
    }

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
    }

    private async Task SaveResource()
    {
        isSaving = true;
        errorMessage = null;
        successMessage = null;

        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var uploaderName = authState.User.Identity?.Name ?? "Unknown";

            if (isEditMode)
            {
                // Update existing resource using EditResourceAsync
                await DigitalResourceService.EditResourceAsync(resourceForm.Id, resourceForm);
                successMessage = "Resource updated successfully!";
            }
            else
            {
                // Create new resource
                // Validate based on category
                if (resourceForm.Category == "Courses")
                {
                    // Courses require ExternalUrl, file is optional (for thumbnail)
                    if (string.IsNullOrEmpty(resourceForm.ExternalUrl))
                    {
                        errorMessage = "External URL is required for courses.";
                        return;
                    }
                }
                else
                {
                    // Non-course resources require a file
                    if (selectedFile == null)
                    {
                        errorMessage = "Please select a file to upload.";
                        return;
                    }
                }

                // Convert IBrowserFile to IFormFile if a file was selected
                IFormFile? formFile = null;
                if (selectedFile != null)
                {
                    var ms = new MemoryStream();
                    await selectedFile.OpenReadStream(10_000_000).CopyToAsync(ms);
                    ms.Position = 0;
                    formFile = new FormFileAdapter(ms, selectedFile.Name, selectedFile.Name, selectedFile.ContentType, ms.Length);
                }

                var createDTO = new CreateDigitalResourceDTO
                {
                    Title = resourceForm.Title,
                    File = formFile,
                    Category = resourceForm.Category,
                    IsFree = resourceForm.IsFree,
                    Price = resourceForm.Price,
                    ThumbnailUrl = resourceForm.ThumbnailUrl,
                    ExternalUrl = resourceForm.ExternalUrl
                };

                await DigitalResourceService.UploadResourceAsync(createDTO, uploaderName);
                successMessage = "Resource added successfully!";
            }

            await LoadResources();
            CloseModal();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving resource: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task ConfirmDelete()
    {
        if (resourceToDelete == null) return;

        isDeleting = true;
        try
        {
            await DigitalResourceService.DeleteResourceAsync(resourceToDelete.Id);
            successMessage = $"Resource '{resourceToDelete.Title}' deleted successfully.";
            await LoadResources();
            CloseModal();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error deleting resource: {ex.Message}";
        }
        finally
        {
            isDeleting = false;
        }
    }

    private void CloseModal()
    {
        showModal = false;
        showDeleteModal = false;
        resourceForm = new();
        resourceToDelete = null;
        selectedFile = null;
    }

    // Helper class to adapt browser file to IFormFile for service layer
    private class FormFileAdapter : IFormFile
    {
        private readonly Stream _stream;
        private readonly string _name;
        private readonly string _fileName;
        private readonly string _contentType;
        private readonly long _length;

        public FormFileAdapter(Stream stream, string name, string fileName, string contentType, long length)
        {
            _stream = stream;
            _name = name;
            _fileName = fileName;
            _contentType = contentType;
            _length = length;
        }

        public string ContentType => _contentType;
        public string ContentDisposition => $"form-data; name=\"{_name}\"; filename=\"{_fileName}\"";
        public IHeaderDictionary Headers => new HeaderDictionary();
        public long Length => _length;
        public string Name => _name;
        public string FileName => _fileName;

        public void CopyTo(Stream target) => _stream.CopyTo(target);
        public Task CopyToAsync(Stream target, CancellationToken cancellationToken = default) => _stream.CopyToAsync(target, cancellationToken);
        public Stream OpenReadStream() => _stream;
    }
}
