@page "/goaltracker"
@layout Views.Shared.MainLayout
@rendermode RenderMode.InteractiveServer

@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Components.Web
@using Tekhnologia.Services.Interfaces
@using Tekhnologia.Models.DTOs
@inject IGoalService GoalService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider

<AuthorizeView Context="authContext">
    <Authorized>
        <!-- üîí Authenticated User Interface -->
        <div class="goal-tracker-page">
        @if (loading)
        {
            <div class="section has-text-centered">
                <p>Loading your goals...</p>
            </div>
        }
        else
        {
            <div class="goal-tracker-container">
                <!-- Left Sidebar: Goals List -->
                <div class="goals-sidebar vision-board-sidebar">
                    <div class="sidebar-header">
                        <h2 class="sidebar-title">My Goals</h2>
                        <button type="button" class="button is-small admin-action-btn" @onclick="ShowCreateModal">+ New Goal</button>
                    </div>

                    <div class="ai-intro">
                        <p>Plan and prioritise your career goals with clarity.</p>
                    </div>

                    <div class="ai-recent box">
                        <h4>Goal List</h4>
                        @if (!goals.Any())
                        {
                            <div class="history-empty">No goals yet.</div>
                        }
                        else
                        {
                            <div class="goals-list">
                                @foreach (var goal in goals.OrderByDescending(g => g.CreatedAt))
                                {
                                    <div class="goal-list-item @(selectedGoal?.GoalId == goal.GoalId ? "active" : "")"
                                         draggable="true"
                                         @ondragstart="@(e => OnGoalDragStart(goal))"
                                         @ondragover="@(e => OnGoalDragOver(goal))"
                                         @ondrop="@(e => OnGoalDrop())"
                                         @onclick="() => SelectGoal(goal)">
                                        <div class="goal-item-header">
                                            <span class="goal-item-title">@goal.Title</span>
                                            @if (goal.IsCompleted)
                                            {
                                                <span class="goal-status-badge completed">‚úì</span>
                                            }
                                        </div>
                                        <div class="goal-item-meta">
                                            <span class="urgency-tag @goal.Urgency.Replace(" ", "-").ToLower()">@goal.Urgency</span>
                                            <span class="importance-tag @goal.Importance.Replace(" ", "-").ToLower()">@goal.Importance</span>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>

                <!-- Right Main Area: Selected Goal Details -->
                <div class="goal-detail-area">
                    <div class="board-header chat-header">
                        <h1 class="board-title">My Goals</h1>
                        <p class="board-subtitle muted">Track progress, deadlines and priorities</p>
                    </div>
                    @if (selectedGoal == null)
                    {
                        <div class="empty-selection">
                            <p>Select a goal from the list to view details</p>
                        </div>
                    }
                    else
                    {
                        <div class="goal-detail-header">
                            <div class="goal-header-text">
                                <h1 class="goal-title">@selectedGoal.Title</h1>
                                <p class="goal-description">@selectedGoal.Description</p>
                            </div>
                            <div class="goal-actions">
                                <button class="button admin-action-btn" @onclick="() => ShowEditModal(selectedGoal)">Edit</button>
                                @if (!selectedGoal.IsCompleted)
                                {
                                    <button class="button user-role-tag" @onclick="async () => await MarkComplete(selectedGoal.GoalId)">Complete</button>
                                }
                                else
                                {
                                    <button class="button user-role-tag is-warning" @onclick="async () => await UnmarkComplete(selectedGoal.GoalId)">Undo Complete</button>
                                }
                                <button class="button admin-action-btn" @onclick="() => ShowDeleteConfirm(selectedGoal)">Delete</button>
                            </div>
                        </div>

                        <!-- Stat Cards -->
                        <div class="stat-cards">
                            <div class="stat-card">
                                <div class="stat-label">Days Into Goal</div>
                                <div class="stat-value">@GetDaysIntoGoal(selectedGoal)</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Days Remaining</div>
                                <div class="stat-value">@GetDaysRemaining(selectedGoal)</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Status</div>
                                <div class="stat-value">@(selectedGoal.IsCompleted ? "Complete" : "Active")</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Priority</div>
                                <div class="stat-value">@GetPriorityLabel(selectedGoal)</div>
                            </div>
                        </div>

                        <!-- Progress Visual -->
                        <div class="progress-section">
                            <h3 class="section-subtitle">Timeline</h3>
                            <div class="timeline-visual">
                                <div class="timeline-bar">
                                    <div class="timeline-progress" style="width: @GetProgressPercentage(selectedGoal)%"></div>
                                </div>
                                <div class="timeline-labels">
                                    <span>Started: @selectedGoal.CreatedAt.ToString("MMM dd, yyyy")</span>
                                    @if (selectedGoal.Deadline.HasValue)
                                    {
                                        <span>Deadline: @selectedGoal.Deadline.Value.ToString("MMM dd, yyyy")</span>
                                    }
                                    else
                                    {
                                        <span>No deadline set</span>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    </div>

    <!-- Create/Edit Goal Modal -->
    @if (showGoalModal)
    {
        <div class="modal is-active" style="display:block !important;">
            <div class="modal-background" @onclick="CloseModal"></div>
            <div class="modal-card">
                <header class="modal-card-head">
                    <p class="modal-card-title">@(isEditMode ? "Edit Goal" : "Create New Goal")</p>
                    <button class="delete" aria-label="close" @onclick="CloseModal"></button>
                </header>
                <section class="modal-card-body">
                    <EditForm Model="@goalForm" OnValidSubmit="@SaveGoal" FormName="GoalModalForm">
                        <DataAnnotationsValidator />

                        <div class="field">
                            <label class="label">Title</label>
                            <div class="control">
                                <InputText class="input" @bind-Value="goalForm.Title" placeholder="e.g., Learn React" />
                            </div>
                            <ValidationMessage For="@(() => goalForm.Title)" />
                        </div>

                        <div class="field">
                            <label class="label">Description</label>
                            <div class="control">
                                <InputTextArea class="textarea" @bind-Value="goalForm.Description" placeholder="What do you want to achieve?" />
                            </div>
                        </div>

                        <div class="field">
                            <label class="label">Deadline (Optional)</label>
                            <div class="control">
                                <InputDate class="input" @bind-Value="goalForm.Deadline" />
                            </div>
                        </div>

                        <div class="columns">
                            <div class="column">
                                <div class="field">
                                    <label class="label">Urgency</label>
                                    <div class="control">
                                        <div class="select">
                                            <InputSelect @bind-Value="goalForm.Urgency">
                                                <option value="Not Urgent">Not Urgent</option>
                                                <option value="Urgent">Urgent</option>
                                            </InputSelect>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="column">
                                <div class="field">
                                    <label class="label">Importance</label>
                                    <div class="control">
                                        <div class="select">
                                            <InputSelect @bind-Value="goalForm.Importance">
                                                <option value="Not Important">Not Important</option>
                                                <option value="Important">Important</option>
                                            </InputSelect>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(modalError))
                        {
                            <div class="notification is-danger is-light">
                                @modalError
                            </div>
                        }

                        <div class="field is-grouped is-grouped-right" style="margin-top: 1.5rem;">
                            <div class="control">
                                <button type="button" class="button" @onclick="CloseModal">Cancel</button>
                            </div>
                            <div class="control">
                                <button type="submit" class="button user-role-tag" disabled="@isSaving">
                                    @(isSaving ? "Saving..." : "Save Goal")
                                </button>
                            </div>
                        </div>
                    </EditForm>
                </section>
            </div>
        </div>
    }

    <!-- Delete Confirmation Modal -->
    @if (showDeleteModal && goalToDelete != null)
    {
        <div class="modal is-active">
            <div class="modal-background" @onclick="CloseModal"></div>
            <div class="modal-card">
                <header class="modal-card-head">
                    <p class="modal-card-title">Confirm Delete</p>
                    <button class="delete" aria-label="close" @onclick="CloseModal"></button>
                </header>
                <section class="modal-card-body">
                    <p>Are you sure you want to delete <strong>@goalToDelete.Title</strong>?</p>
                    <p class="has-text-danger">This action cannot be undone.</p>
                </section>
                <footer class="modal-card-foot">
                    <button class="button admin-action-btn" @onclick="ConfirmDelete" disabled="@isDeleting">
                        @(isDeleting ? "Deleting..." : "Delete")
                    </button>
                    <button class="button" @onclick="CloseModal">Cancel</button>
                </footer>
            </div>
        </div>
    }

    <!-- Success/Error Notifications -->
    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="notification is-success notification-toast">
            <button class="delete" @onclick="() => successMessage = null"></button>
            @successMessage
        </div>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="notification is-danger notification-toast">
            <button class="delete" @onclick="() => errorMessage = null"></button>
            @errorMessage
        </div>
    }
    </Authorized>
    
    <NotAuthorized>
        <!-- üåê Public Marketing Content -->
        <section class="home">
        <div class="home-intro">
            <h1 class="title is-1">Goal Tracker</h1>
            <hr class="hr" />
            <p class="home-text">
                Track your progress, stay motivated, and reach your career aspirations
                with our free goal-tracking tool for women in tech.
            </p>
            <p class="home-subtext">
                Start breaking big dreams into manageable milestones today.
            </p>
            <div class="home-buttons buttons">
                <div class="home-buttons-shine">
                    <a class="shine" href="/signup"><span>Get Started</span></a>
                </div>
            </div>
        </div>
    </section>

    <section class="section">
        <h2 class="title section-title has-text-centered">Why Use a Goal Tracker?</h2>
        <div class="columns is-multiline">
            <div class="column is-half">
                <div class="box home-info-box">
                    <h3>‚úÖ Stay Focused</h3>
                    <p>Break down complex career goals into actionable tasks.</p>
                </div>
            </div>
            <div class="column is-half">
                <div class="box home-info-box">
                    <h3>üìà Visualize Progress</h3>
                    <p>See your advancement over time with intuitive charts.</p>
                </div>
            </div>
            <div class="column is-half">
                <div class="box home-info-box">
                    <h3>üéØ Prioritize Effectively</h3>
                    <p>Use the Eisenhower Matrix to sort urgent vs. important tasks.</p>
                </div>
            </div>
            <div class="column is-half">
                <div class="box home-info-box">
                    <h3>üí™ Build Momentum</h3>
                    <p>Celebrate wins and maintain consistency.</p>
                </div>
            </div>
        </div>
    </section>
    </NotAuthorized>
</AuthorizeView>

@code {
    private List<GoalResponseDTO> goals = new();
    private GoalResponseDTO? selectedGoal;
    private CreateGoalDTO goalForm = new();
    private GoalResponseDTO? goalToDelete;

    private string? userId;
    private string? successMessage;
    private string? errorMessage;
    private string? modalError;

    private bool loading = true;
    private bool showGoalModal = false;
    private bool showDeleteModal = false;
    private bool isEditMode = false;
    private bool isSaving = false;
    private bool isDeleting = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            
            if (!authState.User.Identity?.IsAuthenticated ?? false)
            {
                return;
            }

            userId = authState.User.FindFirstValue(ClaimTypes.NameIdentifier);

            if (string.IsNullOrEmpty(userId))
            {
                Navigation.NavigateTo("/signin");
                return;
            }

            await LoadGoals();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading goals: {ex.Message}";
        }
        finally
        {
            loading = false;
        }
    }

    private async Task LoadGoals()
    {
        if (string.IsNullOrEmpty(userId)) return;

        // Preserve the currently selected goal (by id) when reloading
        var prevSelectedId = selectedGoal?.GoalId;
        goals = await GoalService.GetUserGoalsAsync(userId);

        if (prevSelectedId != null)
        {
            selectedGoal = goals.FirstOrDefault(g => g.GoalId == prevSelectedId) ?? goals.FirstOrDefault();
        }
        else if (goals.Any() && selectedGoal == null)
        {
            selectedGoal = goals.First();
        }
    }

    private void SelectGoal(GoalResponseDTO goal)
    {
        selectedGoal = goal;
    }

    private void ShowCreateModal()
    {
        isEditMode = false;
        goalForm = new CreateGoalDTO
        {
            Urgency = "Not Urgent",
            Importance = "Not Important"
        };
        modalError = null;
        showGoalModal = true;
        InvokeAsync(StateHasChanged);
    }

    private void ShowEditModal(GoalResponseDTO goal)
    {
        isEditMode = true;
        goalForm = new CreateGoalDTO
        {
            Title = goal.Title,
            Description = goal.Description,
            Deadline = goal.Deadline,
            Urgency = goal.Urgency,
            Importance = goal.Importance
        };
        modalError = null;
        showGoalModal = true;
    }

    private void ShowDeleteConfirm(GoalResponseDTO goal)
    {
        goalToDelete = goal;
        showDeleteModal = true;
    }

    private async Task SaveGoal()
    {
        if (string.IsNullOrEmpty(userId)) return;

        isSaving = true;
        modalError = null;

        try
        {
            if (isEditMode && selectedGoal != null)
            {
                var (success, error, _) = await GoalService.UpdateGoalAsync(selectedGoal.GoalId, goalForm, userId);
                if (success)
                {
                    successMessage = "Goal updated successfully!";
                    await LoadGoals();
                    CloseModal();
                }
                else
                {
                    modalError = error;
                }
            }
            else
            {
                await GoalService.CreateGoalAsync(userId, goalForm);
                successMessage = "Goal created successfully!";
                await LoadGoals();
                CloseModal();
            }
        }
        catch (Exception ex)
        {
            modalError = $"Error saving goal: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task MarkComplete(Guid goalId)
    {
        if (string.IsNullOrEmpty(userId)) return;

        try
        {
            var (success, error, _) = await GoalService.MarkGoalAsCompletedAsync(goalId, userId);
            if (success)
            {
                successMessage = "Goal marked as completed!";
                await LoadGoals();
            }
            else
            {
                errorMessage = error;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error completing goal: {ex.Message}";
        }
    }

    private async Task UnmarkComplete(Guid goalId)
    {
        if (string.IsNullOrEmpty(userId)) return;

        try
        {
            var (success, error, _) = await GoalService.UnmarkGoalAsCompletedAsync(goalId, userId);
            if (success)
            {
                successMessage = "Goal marked as incomplete.";
                await LoadGoals();
            }
            else
            {
                errorMessage = error;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error updating goal: {ex.Message}";
        }
    }

    // Drag and drop reorder (client-side visual only)
    private int? dragSourceIndex = null;
    private int? dragTargetIndex = null;

    private void OnGoalDragStart(GoalResponseDTO goal)
    {
        dragSourceIndex = goals.FindIndex(g => g.GoalId == goal.GoalId);
    }

    private void OnGoalDragOver(GoalResponseDTO goal)
    {
        dragTargetIndex = goals.FindIndex(g => g.GoalId == goal.GoalId);
    }

    private void OnGoalDrop()
    {
        if (dragSourceIndex.HasValue && dragTargetIndex.HasValue && dragSourceIndex.Value != dragTargetIndex.Value)
        {
            var item = goals[dragSourceIndex.Value];
            goals.RemoveAt(dragSourceIndex.Value);
            // Adjust target index if source was before target and removed
            var insertIndex = dragTargetIndex.Value;
            if (dragSourceIndex.Value < dragTargetIndex.Value) insertIndex--;
            goals.Insert(insertIndex, item);
            // re-select moved item
            selectedGoal = goals.FirstOrDefault(g => g.GoalId == item.GoalId);
            StateHasChanged();
        }
        dragSourceIndex = null;
        dragTargetIndex = null;
    }

    

    private async Task ConfirmDelete()
    {
        if (string.IsNullOrEmpty(userId) || goalToDelete == null) return;

        isDeleting = true;

        try
        {
            var (success, error) = await GoalService.DeleteGoalAsync(goalToDelete.GoalId, userId);
            if (success)
            {
                successMessage = "Goal deleted successfully!";
                await LoadGoals();
                CloseModal();
            }
            else
            {
                errorMessage = error;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error deleting goal: {ex.Message}";
        }
        finally
        {
            isDeleting = false;
        }
    }

    private void CloseModal()
    {
        showGoalModal = false;
        showDeleteModal = false;
        goalToDelete = null;
        modalError = null;
    }

    // Helper methods for stats
    private int GetDaysIntoGoal(GoalResponseDTO goal)
    {
        return (DateTime.UtcNow - goal.CreatedAt).Days;
    }

    private string GetDaysRemaining(GoalResponseDTO goal)
    {
        if (!goal.Deadline.HasValue)
            return "No deadline";

        var remaining = (goal.Deadline.Value - DateTime.UtcNow).Days;
        return remaining > 0 ? remaining.ToString() : "Overdue";
    }

    private double GetProgressPercentage(GoalResponseDTO goal)
    {
        if (!goal.Deadline.HasValue)
            return 0;

        var totalDays = (goal.Deadline.Value - goal.CreatedAt).TotalDays;
        var daysPassed = (DateTime.UtcNow - goal.CreatedAt).TotalDays;

        if (totalDays <= 0) return 100;

        var percentage = (daysPassed / totalDays) * 100;
        return Math.Min(Math.Max(percentage, 0), 100);
    }

    private string GetPriorityLabel(GoalResponseDTO goal)
    {
        if (goal.Urgency == "Urgent" && goal.Importance == "Important")
            return "Critical";
        if (goal.Urgency == "Urgent")
            return "High";
        if (goal.Importance == "Important")
            return "Medium";
        return "Low";
    }
}

else
{
    <!-- üåê Public Marketing Content -->
    <section class="home">
        <div class="home-intro">
            <h1 class="title is-1">Goal Tracker</h1>
            <hr class="hr" />
            <p class="home-text">
                Track your progress, stay motivated, and reach your career aspirations
                with our free goal-tracking tool for women in tech.
            </p>
            <p class="home-subtext">
                Start breaking big dreams into manageable milestones today.
            </p>
            <div class="home-buttons buttons">
                <div class="home-buttons-shine">
                    <a class="shine" href="/signup"><span>Get Started</span></a>
                </div>
            </div>
        </div>
    </section>

    <section class="section">
        <h2 class="title section-title has-text-centered">Why Use a Goal Tracker?</h2>
        <div class="columns is-multiline">
            <div class="column is-half">
                <div class="box">
                    <h3 class="title is-5">üöÄ Boosts Productivity</h3>
                    <p>Setting goals and tracking progress increases efficiency.</p>
                </div>
            </div>
            <div class="column is-half">
                <div class="box">
                    <h3 class="title is-5">üí° Enhances Motivation</h3>
                    <p>Seeing your progress keeps you moving forward.</p>
                </div>
            </div>
            <div class="column is-half">
                <div class="box">
                    <h3 class="title is-5">‚úÖ Helps with Prioritization</h3>
                    <p>Organize career goals effectively.</p>
                </div>
            </div>
            <div class="column is-half">
                <div class="box">
                    <h3 class="title is-5">üéâ Celebrates Achievements</h3>
                    <p>Small wins lead to big success!</p>
                </div>
            </div>
        </div>
    </section>

    <section class="section has-text-centered">
        <h2 class="title section-title">How It Works</h2>
        <div class="feature-boxes-row">
            <div class="feature-box">
                <h3>Set Your Career Goals</h3>
                <p class="feature-subtext">Define your objectives clearly.</p>
            </div>
            <div class="feature-box">
                <h3>Track Your Progress</h3>
                <p class="feature-subtext">Use checklists, progress bars, and milestones.</p>
            </div>
            <div class="feature-box">
                <h3>Stay on Course</h3>
                <p class="feature-subtext">Get personalized reminders and motivational insights.</p>
            </div>
            <div class="feature-box">
                <h3>Celebrate Achievements</h3>
                <p class="feature-subtext">Reflect on your journey and stay inspired.</p>
            </div>
        </div>
    </section>

    <section class="section">
        <h2 class="title section-title has-text-centered">What You Get</h2>
        <div class="columns is-multiline">
            <div class="column is-half">
                <div class="box">
                    <h3 class="title is-5">üéØ Set SMART Career Goals</h3>
                </div>
            </div>
            <div class="column is-half">
                <div class="box">
                    <h3 class="title is-5">üìà Visual Progress Tracking</h3>
                </div>
            </div>
            <div class="column is-half">
                <div class="box">
                    <h3 class="title is-5">‚è≥ Prioritize Tasks</h3>
                </div>
            </div>
            <div class="column is-half">
                <div class="box">
                    <h3 class="title is-5">üîî Email Reminders & Updates</h3>
                </div>
            </div>
        </div>
    </section>

    <section class="section has-text-centered">
        <h2 class="title section-title">Ready to take your career to the next level?</h2>
        <div class="home-buttons buttons">
            <div class="home-buttons-shine">
                <a class="shine" href="/signup"><span>Get Started</span></a>
            </div>
        </div>
    </section>
}