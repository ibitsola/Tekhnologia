@page "/admin/resources"
@layout Views.Shared.MainLayout
@using Microsoft.AspNetCore.Components
@rendermode RenderMode.InteractiveServer

@using System.Net.Http.Json
@using Tekhnologia.Models.DTOs
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Components.Web
@inject HttpClient Http
@inject NavigationManager Navigation

<AuthorizeView Roles="Admin" Context="authContext">
    <Authorized>
        <div class="section admin-page">
            <div class="container">
                <h1 class="title">Resource Management</h1>

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="notification is-danger">
                        <button class="delete" @onclick="() => errorMessage = null"></button>
                        @errorMessage
                    </div>
                }

                @if (!string.IsNullOrEmpty(successMessage))
                {
                    <div class="notification is-success">
                        <button class="delete" @onclick="() => successMessage = null"></button>
                        @successMessage
                    </div>
                }

                <div class="level">
                    <div class="level-left">
                        <div class="level-item">
                            <h2 class="subtitle">All Resources</h2>
                        </div>
                    </div>
                    <div class="level-right">
                        <div class="level-item">
                            <button class="button user-role-tag" @onclick="ShowAddModal">+ Add Resource</button>
                        </div>
                    </div>
                </div>

                @if (loading)
                {
                    <div class="notification is-info">Loading...</div>
                }
                else if (resources == null || !resources.Any())
                {
                    <div class="notification is-warning">No resources found.</div>
                }
                else
                {
                    <div class="box">
                        <table class="table is-fullwidth is-striped is-hoverable">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Category</th>
                                    <th>Type</th>
                                    <th>Price</th>
                                    <th>Uploaded</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var r in resources)
                                {
                                    <tr>
                                        <td>@r.Title</td>
                                        <td>
                                            <span class="tag">@r.Category</span>
                                        </td>
                                        <td>@r.FileType</td>
                                        <td>
                                            @if (r.IsFree)
                                            {
                                                <span class="tag user-role-tag">Free</span>
                                            }
                                            else
                                            {
                                                <span class="tag admin-role-tag">Â£@r.Price?.ToString("F2")</span>
                                            }
                                        </td>
                                        <td>@r.UploadDate.ToString("MMM dd, yyyy")</td>
                                        <td>
                                            <div class="buttons are-small">
                                                <button class="button admin-action-btn" @onclick="() => ShowEditModal(r)">Edit</button>
                                                <button class="button admin-action-btn" @onclick="() => ShowDeleteConfirm(r)">Delete</button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>

        <!-- Add/Edit Modal -->
        @if (showModal)
        {
            <div class="modal is-active">
                <div class="modal-background" @onclick="CloseModal"></div>
                <div class="modal-card">
                    <header class="modal-card-head">
                        <p class="modal-card-title">@(isEditMode ? "Edit Resource" : "Add Resource")</p>
                        <button class="delete" aria-label="close" @onclick="CloseModal"></button>
                    </header>
                    <section class="modal-card-body">
                        <EditForm Model="@resourceForm" OnValidSubmit="@SaveResource">
                            <div class="field">
                                <label class="label">Title</label>
                                <div class="control">
                                    <input class="input" @bind="resourceForm.Title" required />
                                </div>
                            </div>

                            <div class="field">
                                <label class="label">Category</label>
                                <div class="control">
                                    <div class="select is-fullwidth">
                                        <select @bind="resourceForm.Category">
                                            <option value="">-- Select Category --</option>
                                            <option value="Books">Books</option>
                                            <option value="Images">Images</option>
                                            <option value="Courses">Courses</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            @if (resourceForm.Category == "Courses")
                            {
                                <div class="field">
                                    <label class="label">External URL</label>
                                    <div class="control">
                                        <input class="input" type="url" @bind="resourceForm.ExternalUrl" placeholder="https://..." />
                                    </div>
                                    <p class="help">For courses, provide the external link instead of uploading a file</p>
                                </div>
                            }
                            else
                            {
                                <div class="field">
                                    <label class="label">Upload File</label>
                                    <div class="control">
                                        <InputFile OnChange="OnFileSelected" />
                                    </div>
                                    @if (!string.IsNullOrEmpty(resourceForm.FilePath))
                                    {
                                        <p class="help">Current file: @Path.GetFileName(resourceForm.FilePath)</p>
                                    }
                                </div>
                            }

                            <div class="field">
                                <label class="label">Thumbnail URL (optional)</label>
                                <div class="control">
                                    <input class="input" type="url" @bind="resourceForm.ThumbnailUrl" placeholder="https://..." />
                                </div>
                            </div>

                            <div class="field">
                                <label class="label">Price</label>
                                <div class="control">
                                    <input class="input" type="number" step="0.01" @bind="resourceForm.Price" placeholder="0.00 (Free if empty)" />
                                </div>
                            </div>

                            <div class="field">
                                <div class="control">
                                    <label class="checkbox">
                                        <input type="checkbox" @bind="resourceForm.IsFree" />
                                        Free Resource
                                    </label>
                                </div>
                            </div>

                            <div class="field is-grouped is-grouped-right">
                                <div class="control">
                                    <button type="submit" class="button user-role-tag" disabled="@isSaving">
                                        @(isSaving ? "Saving..." : "Save")
                                    </button>
                                </div>
                                <div class="control">
                                    <button type="button" class="button" @onclick="CloseModal">Cancel</button>
                                </div>
                            </div>
                        </EditForm>
                    </section>
                </div>
            </div>
        }

        <!-- Delete Confirmation Modal -->
        @if (showDeleteModal && resourceToDelete != null)
        {
            <div class="modal is-active">
                <div class="modal-background" @onclick="CloseModal"></div>
                <div class="modal-card">
                    <header class="modal-card-head">
                        <p class="modal-card-title">Confirm Deletion</p>
                        <button class="delete" aria-label="close" @onclick="CloseModal"></button>
                    </header>
                    <section class="modal-card-body">
                        <p>Are you sure you want to delete <strong>@resourceToDelete.Title</strong>?</p>
                        <p class="has-text-danger">This action cannot be undone!</p>
                    </section>
                    <footer class="modal-card-foot">
                        <button class="button is-danger" @onclick="ConfirmDelete" disabled="@isDeleting">
                            @(isDeleting ? "Deleting..." : "Delete")
                        </button>
                        <button class="button" @onclick="CloseModal">Cancel</button>
                    </footer>
                </div>
            </div>
        }
    </Authorized>
    
    <NotAuthorized>
        <div class="section">
            <div class="notification is-danger">
                Access Denied. Admins only.
            </div>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private List<DigitalResourceDTO>? resources;
    private DigitalResourceDTO resourceForm = new();
    private DigitalResourceDTO? resourceToDelete;
    private IBrowserFile? selectedFile;
    private bool loading = true;
    private bool showModal = false;
    private bool showDeleteModal = false;
    private bool isEditMode = false;
    private bool isSaving = false;
    private bool isDeleting = false;
    private string? errorMessage;
    private string? successMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadResources();
    }

    private async Task LoadResources()
    {
        try
        {
            loading = true;
            resources = await Http.GetFromJsonAsync<List<DigitalResourceDTO>>("/api/digitalresources");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading resources: {ex.Message}";
        }
        finally
        {
            loading = false;
        }
    }

    private void ShowAddModal()
    {
        isEditMode = false;
        resourceForm = new DigitalResourceDTO { IsFree = true };
        selectedFile = null;
        showModal = true;
    }

    private void ShowEditModal(DigitalResourceDTO resource)
    {
        isEditMode = true;
        resourceForm = new DigitalResourceDTO
        {
            Id = resource.Id,
            Title = resource.Title,
            Category = resource.Category,
            FileType = resource.FileType,
            FilePath = resource.FilePath,
            ThumbnailUrl = resource.ThumbnailUrl,
            ExternalUrl = resource.ExternalUrl,
            IsFree = resource.IsFree,
            Price = resource.Price
        };
        selectedFile = null;
        showModal = true;
    }

    private void ShowDeleteConfirm(DigitalResourceDTO resource)
    {
        resourceToDelete = resource;
        showDeleteModal = true;
    }

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
    }

    private async Task SaveResource()
    {
        isSaving = true;
        errorMessage = null;
        successMessage = null;

        try
        {
            if (isEditMode)
            {
                // Update existing resource
                if (selectedFile != null)
                {
                    // Upload new file
                    var content = new MultipartFormDataContent();
                    var stream = selectedFile.OpenReadStream(10_000_000);
                    content.Add(new StreamContent(stream), "file", selectedFile.Name);
                    content.Add(new StringContent(resourceForm.Title), "Title");
                    content.Add(new StringContent(resourceForm.Category ?? ""), "Category");
                    if (!resourceForm.IsFree && resourceForm.Price.HasValue)
                        content.Add(new StringContent(resourceForm.Price.Value.ToString()), "Price");
                    if (!string.IsNullOrEmpty(resourceForm.ThumbnailUrl))
                        content.Add(new StringContent(resourceForm.ThumbnailUrl), "ThumbnailUrl");
                    if (!string.IsNullOrEmpty(resourceForm.ExternalUrl))
                        content.Add(new StringContent(resourceForm.ExternalUrl), "ExternalUrl");

                    var res = await Http.PutAsync($"/api/digitalresources/{resourceForm.Id}", content);
                    if (!res.IsSuccessStatusCode)
                    {
                        errorMessage = await res.Content.ReadAsStringAsync();
                        return;
                    }
                }
                else
                {
                    // Update without file
                    var res = await Http.PutAsJsonAsync($"/api/digitalresources/{resourceForm.Id}", resourceForm);
                    if (!res.IsSuccessStatusCode)
                    {
                        errorMessage = await res.Content.ReadAsStringAsync();
                        return;
                    }
                }

                successMessage = "Resource updated successfully!";
            }
            else
            {
                // Create new resource
                if (resourceForm.Category == "Courses")
                {
                    // For courses, just save the metadata with external URL
                    var res = await Http.PostAsJsonAsync("/api/digitalresources", resourceForm);
                    if (!res.IsSuccessStatusCode)
                    {
                        errorMessage = await res.Content.ReadAsStringAsync();
                        return;
                    }
                }
                else
                {
                    // For books/images, require file upload
                    if (selectedFile == null)
                    {
                        errorMessage = "Please select a file to upload.";
                        return;
                    }

                    var content = new MultipartFormDataContent();
                    var stream = selectedFile.OpenReadStream(10_000_000);
                    content.Add(new StreamContent(stream), "file", selectedFile.Name);
                    content.Add(new StringContent(resourceForm.Title), "Title");
                    content.Add(new StringContent(resourceForm.Category ?? ""), "Category");
                    if (!resourceForm.IsFree && resourceForm.Price.HasValue)
                        content.Add(new StringContent(resourceForm.Price.Value.ToString()), "Price");
                    if (!string.IsNullOrEmpty(resourceForm.ThumbnailUrl))
                        content.Add(new StringContent(resourceForm.ThumbnailUrl), "ThumbnailUrl");

                    var res = await Http.PostAsync("/api/digitalresources/upload", content);
                    if (!res.IsSuccessStatusCode)
                    {
                        errorMessage = await res.Content.ReadAsStringAsync();
                        return;
                    }
                }

                successMessage = "Resource added successfully!";
            }

            await LoadResources();
            CloseModal();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving resource: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task ConfirmDelete()
    {
        if (resourceToDelete == null) return;

        isDeleting = true;
        try
        {
            var res = await Http.DeleteAsync($"/api/digitalresources/{resourceToDelete.Id}");
            if (res.IsSuccessStatusCode)
            {
                successMessage = $"Resource '{resourceToDelete.Title}' deleted successfully.";
                await LoadResources();
                CloseModal();
            }
            else
            {
                errorMessage = await res.Content.ReadAsStringAsync();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error deleting resource: {ex.Message}";
        }
        finally
        {
            isDeleting = false;
        }
    }

    private void CloseModal()
    {
        showModal = false;
        showDeleteModal = false;
        resourceForm = new();
        resourceToDelete = null;
        selectedFile = null;
    }
}
