@page "/goaltracker"
@using Microsoft.AspNetCore.Components.Forms
@using Tekhnologia.UI.Services.Interfaces
@using Tekhnologia.UI.Services
@inject IAuthStateService AuthState
@inject IGoalApiService GoalApi
@inject IUserClient UserClient
@inject NavigationManager Nav

@if (!AuthState.Initialized)
{
    <div class="section has-text-centered"><p>Loading...</p></div>
}
else if (!AuthState.IsLoggedIn)
{
    <!-- Public marketing content -->
    <section class="home">
        <div class="home-intro">
            <h1 class="title is-1">Goal Tracker</h1>
            <hr class="hr" />
            <p class="home-text">Track your progress, stay motivated, and reach your career aspirations.</p>
            <p class="home-subtext">Start breaking big dreams into manageable milestones today.</p>
            <div class="home-buttons buttons">
                <div class="home-buttons-shine">
                    <a class="shine" href="/signup"><span>Get Started</span></a>
                </div>
            </div>
        </div>
    </section>
    <section class="section">
        <h2 class="title section-title has-text-centered">Why Use a Goal Tracker?</h2>
        <div class="columns is-multiline">
            <div class="column is-half"><div class="box home-info-box"><h3>âœ… Stay Focused</h3><p>Break down complex career goals into actionable tasks.</p></div></div>
            <div class="column is-half"><div class="box home-info-box"><h3>ðŸ“ˆ Visualize Progress</h3><p>See your advancement over time with intuitive timeline.</p></div></div>
            <div class="column is-half"><div class="box home-info-box"><h3>ðŸŽ¯ Prioritize Effectively</h3><p>Use urgency & importance to identify priority.</p></div></div>
            <div class="column is-half"><div class="box home-info-box"><h3>ðŸ’ª Build Momentum</h3><p>Celebrate wins and maintain consistency.</p></div></div>
        </div>
    </section>
}
else
{
    <div class="goal-tracker-page">
        @if (loading)
        {
            <div class="section has-text-centered"><p>Loading your goals...</p></div>
        }
        else
        {
            <div class="goal-tracker-container">
                <!-- Sidebar -->
                <div class="goals-sidebar">
                    <div class="sidebar-header">
                        <h2 class="sidebar-title">My Goals</h2>
                        <button type="button" class="button is-small admin-action-btn" @onclick="ShowCreateModal">+ New Goal</button>
                    </div>

                    @if (!goals.Any())
                    {
                        <div class="empty-state"><p>No goals yet!</p><p class="has-text-grey-light">Create your first goal to get started.</p></div>
                    }
                    else
                    {
                        <div class="goals-list">
                            @foreach (var g in goals)
                            {
                                <div class="goal-list-item @(selectedGoal?.GoalId == g.GoalId ? "active" : string.Empty)" @onclick="() => SelectGoal(g)">
                                    <div class="goal-item-header">
                                        <span class="goal-item-title">@g.Title</span>
                                        @if (g.IsCompleted)
                                        {
                                            <span class="goal-status-badge completed">âœ“</span>
                                        }
                                    </div>
                                    <div class="goal-item-meta">
                                        <span class="urgency-tag @g.Urgency.Replace(" ", "-").ToLower()">@g.Urgency</span>
                                        <span class="importance-tag @g.Importance.Replace(" ", "-").ToLower()">@g.Importance</span>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>

                <!-- Detail Area -->
                <div class="goal-detail-area">
                    @if (selectedGoal == null)
                    {
                        <div class="empty-selection"><p>Select a goal from the list to view details</p></div>
                    }
                    else
                    {
                        <div class="goal-detail-header">
                            <div class="goal-header-text">
                                <h1 class="goal-title">@selectedGoal.Title</h1>
                                <p class="goal-description">@selectedGoal.Description</p>
                            </div>
                            <div class="goal-actions">
                                @if (!selectedGoal.IsCompleted)
                                {
                                    <button class="button admin-action-btn" @onclick="() => ShowEditModal(selectedGoal)">Edit</button>
                                    <button class="button user-role-tag" @onclick="() => MarkComplete(selectedGoal.GoalId)">Complete</button>
                                }
                                <button class="button admin-action-btn" @onclick="() => ShowDeleteConfirm(selectedGoal)">Delete</button>
                            </div>
                        </div>
                        <div class="stat-cards">
                            <div class="stat-card"><div class="stat-label">Days Into Goal</div><div class="stat-value">@GoalHelpers.DaysIntoGoal(selectedGoal)</div></div>
                            <div class="stat-card"><div class="stat-label">Days Remaining</div><div class="stat-value">@(GoalHelpers.DaysRemaining(selectedGoal)?.ToString() ?? "-")</div></div>
                            <div class="stat-card"><div class="stat-label">Status</div><div class="stat-value">@(selectedGoal.IsCompleted ? "Complete" : "Active")</div></div>
                            <div class="stat-card"><div class="stat-label">Priority</div><div class="stat-value">@GoalHelpers.PriorityLabel(selectedGoal)</div></div>
                        </div>
                        <div class="progress-section">
                            <h3 class="section-subtitle">Timeline</h3>
                            <div class="timeline-visual">
                                <div class="timeline-bar">
                                    <div class="timeline-progress" style="width: @GoalHelpers.ProgressPercentage(selectedGoal)%"></div>
                                </div>
                                <div class="timeline-labels">
                                    <span>Started: @selectedGoal.CreatedAt.ToString("MMM dd, yyyy")</span>
                                    @if (selectedGoal.Deadline.HasValue)
                                    {
                                        <span>Deadline: @selectedGoal.Deadline.Value.ToString("MMM dd, yyyy")</span>
                                    }
                                    else
                                    {
                                        <span>No deadline set</span>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    </div>

    <!-- Create/Edit Modal -->
    @if (showGoalModal)
    {
        <div class="modal is-active">
            <div class="modal-background" @onclick="CloseModal"></div>
            <div class="modal-card">
                <header class="modal-card-head">
                    <p class="modal-card-title">@(isEditMode ? "Edit Goal" : "Create New Goal")</p>
                    <button class="delete" aria-label="close" @onclick="CloseModal"></button>
                </header>
                <section class="modal-card-body">
                    <EditForm Model="goalForm" OnValidSubmit="SaveGoal">
                        <DataAnnotationsValidator />
                        <div class="field">
                            <label class="label">Title</label>
                            <InputText class="input" @bind-Value="goalForm.Title" />
                            <ValidationMessage For="(()=>goalForm.Title)" />
                        </div>
                        <div class="field">
                            <label class="label">Description</label>
                            <InputTextArea class="textarea" @bind-Value="goalForm.Description" />
                        </div>
                        <div class="field">
                            <label class="label">Deadline (Optional)</label>
                            <InputDate class="input" @bind-Value="goalForm.Deadline" />
                        </div>
                        <div class="columns">
                            <div class="column">
                                <div class="field">
                                    <label class="label">Urgency</label>
                                    <div class="select">
                                        <InputSelect @bind-Value="goalForm.Urgency">
                                            <option value="Not Urgent">Not Urgent</option>
                                            <option value="Urgent">Urgent</option>
                                        </InputSelect>
                                    </div>
                                </div>
                            </div>
                            <div class="column">
                                <div class="field">
                                    <label class="label">Importance</label>
                                    <div class="select">
                                        <InputSelect @bind-Value="goalForm.Importance">
                                            <option value="Not Important">Not Important</option>
                                            <option value="Important">Important</option>
                                        </InputSelect>
                                    </div>
                                </div>
                            </div>
                        </div>
                        @if (!string.IsNullOrEmpty(modalError))
                        {
                            <div class="notification is-danger is-light">@modalError</div>
                        }
                        <div class="field is-grouped is-grouped-right" style="margin-top:1.5rem;">
                            <div class="control"><button type="button" class="button" @onclick="CloseModal">Cancel</button></div>
                            <div class="control"><button type="submit" class="button user-role-tag" disabled="@isSaving">@(isSaving?"Saving...":"Save Goal")</button></div>
                        </div>
                    </EditForm>
                </section>
            </div>
        </div>
    }

    <!-- Delete Modal -->
    @if (showDeleteModal && goalToDelete != null)
    {
        <div class="modal is-active">
            <div class="modal-background" @onclick="CloseModal"></div>
            <div class="modal-card">
                <header class="modal-card-head"><p class="modal-card-title">Confirm Delete</p><button class="delete" aria-label="close" @onclick="CloseModal"></button></header>
                <section class="modal-card-body">
                    <p>Are you sure you want to delete <strong>@goalToDelete.Title</strong>?</p>
                    <p class="has-text-danger">This action cannot be undone.</p>
                </section>
                <footer class="modal-card-foot">
                    <button class="button admin-action-btn" @onclick="ConfirmDelete" disabled="@isDeleting">@(isDeleting?"Deleting...":"Delete")</button>
                    <button class="button" @onclick="CloseModal">Cancel</button>
                </footer>
            </div>
        </div>
    }

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="notification is-success notification-toast">
            <button class="delete" @onclick="() => successMessage = null"></button>@successMessage
        </div>
    }
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="notification is-danger notification-toast">
            <button class="delete" @onclick="() => errorMessage = null"></button>@errorMessage
        </div>
    }
}

@code {
    private List<GoalResponseDTO> goals = new();
    private GoalResponseDTO? selectedGoal;
    private CreateGoalDTO goalForm = new();
    private GoalResponseDTO? goalToDelete;

    private string? userId;
    private string? successMessage;
    private string? errorMessage;
    private string? modalError;

    private bool loading = true;
    private bool showGoalModal;
    private bool showDeleteModal;
    private bool isEditMode;
    private bool isSaving;
    private bool isDeleting;

    protected override async Task OnInitializedAsync()
    {
        if (!AuthState.Initialized)
            await AuthState.RefreshAsync();
        if (!AuthState.IsLoggedIn) return;

        var user = await UserClient.GetCurrentUserAsync();
        userId = user?.Id;
        if (string.IsNullOrEmpty(userId)) { errorMessage = "User ID not found."; loading = false; return; }
        await LoadGoals();
        loading = false;
    }

    private async Task LoadGoals()
    {
        if (string.IsNullOrEmpty(userId)) return;
        goals = (await GoalApi.GetUserGoalsAsync(userId)).ToList();
        if (goals.Any() && selectedGoal == null)
            selectedGoal = goals.First();
        else if (selectedGoal != null && !goals.Any(g => g.GoalId == selectedGoal.GoalId))
            selectedGoal = goals.FirstOrDefault();
        StateHasChanged();
    }

    private void SelectGoal(GoalResponseDTO goal) => selectedGoal = goal;

    private void ShowCreateModal()
    {
        isEditMode = false;
        goalForm = new CreateGoalDTO();
        modalError = null;
        showGoalModal = true;
    }

    private void ShowEditModal(GoalResponseDTO goal)
    {
        isEditMode = true;
        goalForm = new CreateGoalDTO
        {
            Title = goal.Title,
            Description = goal.Description,
            Deadline = goal.Deadline,
            Urgency = goal.Urgency,
            Importance = goal.Importance
        };
        modalError = null;
        showGoalModal = true;
    }

    private async Task SaveGoal()
    {
        if (string.IsNullOrEmpty(userId)) { modalError = "User missing."; return; }
        isSaving = true; modalError = null;
        if (!isEditMode)
        {
            var (ok, err, created) = await GoalApi.CreateGoalAsync(userId, goalForm);
            if (!ok || created == null) { modalError = err ?? "Failed to create goal"; isSaving = false; return; }
            successMessage = "Goal created"; goals.Add(created); selectedGoal = created;
        }
        else if (selectedGoal != null)
        {
            var updateDto = new UpdateGoalDTO
            {
                Title = goalForm.Title,
                Description = goalForm.Description,
                Deadline = goalForm.Deadline,
                Urgency = goalForm.Urgency,
                Importance = goalForm.Importance
            };
            var (ok, err) = await GoalApi.UpdateGoalAsync(selectedGoal.GoalId, userId, updateDto);
            if (!ok) { modalError = err ?? "Failed to update goal"; isSaving = false; return; }
            successMessage = "Goal updated";
            // refresh list to reflect updates
            await LoadGoals();
            selectedGoal = goals.FirstOrDefault(g => g.GoalId == selectedGoal.GoalId);
        }
        isSaving = false; showGoalModal = false;
    }

    private void ShowDeleteConfirm(GoalResponseDTO goal)
    {
        goalToDelete = goal; showDeleteModal = true; isDeleting = false; modalError = null;
    }

    private async Task ConfirmDelete()
    {
        if (goalToDelete == null || string.IsNullOrEmpty(userId)) return;
        isDeleting = true;
        var (ok, err) = await GoalApi.DeleteGoalAsync(goalToDelete.GoalId, userId);
        if (!ok) { errorMessage = err ?? "Failed to delete goal"; isDeleting = false; return; }
        successMessage = "Goal deleted";
        goals.RemoveAll(g => g.GoalId == goalToDelete.GoalId);
        if (selectedGoal?.GoalId == goalToDelete.GoalId)
            selectedGoal = goals.FirstOrDefault();
        isDeleting = false; showDeleteModal = false; goalToDelete = null;
    }

    private async Task MarkComplete(string goalId)
    {
        if (string.IsNullOrEmpty(userId)) return;
        var (ok, err) = await GoalApi.MarkCompleteAsync(goalId, userId);
        if (!ok) { errorMessage = err ?? "Failed to mark complete"; return; }
        successMessage = "Goal marked complete";
        await LoadGoals();
    }

    private void CloseModal()
    {
        showGoalModal = false; showDeleteModal = false; goalToDelete = null; modalError = null;
    }
}
