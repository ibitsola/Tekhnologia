@page "/aicoach"
@using Microsoft.AspNetCore.Components.Forms
@using Tekhnologia.UI.Services.Interfaces
@using Tekhnologia.UI.Components
@inject IAuthStateService AuthState
@inject IAIApiService AiApi
@inject NavigationManager Nav

@if (!AuthState.Initialized)
{
    <p>Loading...</p>
}
else if (!AuthState.IsLoggedIn)
{
    <RedirectToSignIn />
}
else
{
    <section class="section ai-coach-wrapper">
        <div class="ai-image-container">
            <img class="ai-img" src="images/AICoachEve.png" alt="AI coach" />
        </div>
        <div class="ai-chat-box box">
            @foreach (var l in log)
            {
                <p><strong>@l.Role:</strong> @l.Text</p>
            }
            <EditForm Model="model" OnSubmit="Send">
                <InputTextArea @bind-Value="model.Message" class="textarea" placeholder="Ask your AI coach anything…" />
                <button type="submit" class="button is-primary send-btn" disabled="@busy">@(busy?"Sending…":"Send")</button>
            </EditForm>
            @if (!string.IsNullOrWhiteSpace(error))
            {
                <div class="notification is-danger mt-2">@error</div>
            }
        </div>
    </section>
}

@code {
    private record Line(string Role, string Text);
    private ChatRequestDTO model = new();
    private List<Line> log = new();
    private bool busy;
    private string? error;

    protected override async Task OnInitializedAsync()
    {
        if (!AuthState.Initialized)
            await AuthState.RefreshAsync();
        if (!AuthState.IsLoggedIn) return;
    }

    private async Task Send()
    {
        var msg = model.Message?.Trim();
        if (busy || string.IsNullOrEmpty(msg)) return;
        busy = true; error = null;
        log.Add(new("You", msg));
        model.Message = string.Empty;
        try
        {
            var reply = await AiApi.GetBusinessCoachingResponseAsync(msg);
            log.Add(new("AI", reply ?? "(no response)"));
        }
        catch (Exception ex)
        {
            error = $"❌ {ex.Message}";
        }
        finally
        {
            busy = false;
        }
    }
}