@page "/aicoach"
@rendermode RenderMode.InteractiveServer
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Tekhnologia.UI.Views.Shared
@using Tekhnologia.Models.DTOs
@using Tekhnologia.Services.Interfaces
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Components.Web
@inject IAIService Ai
@inject IAuthStateService Auth
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JSRuntime
@inject HttpClient Http

<AuthorizeView Context="authContext">
    <Authorized Context="authContext">
        <div class="goal-tracker-page">
        <div class="goal-tracker-container">
            <div class="goals-sidebar vision-board-sidebar">
                <div class="sidebar-header">
                    <h2 class="sidebar-title">My Eve</h2>
                    <button type="button" class="button is-small admin-action-btn" @onclick="NewChat">+ New Chat</button>
                </div>

                <div class="ai-intro">
                    <p>Ask career coaching questions. Clear, kind, practical guidance.</p>
                </div>

                <div class="ai-recent box">
                    <div class="sidebar-header">
                        <h4>Recent Conversations</h4>
                    </div>
                    @if (conversations is null)
                    {
                        <div>Loading…</div>
                    }
                    else if (!conversations.Any())
                    {
                        <div class="history-empty">No conversations yet.</div>
                    }
                    else
                    {
                        <ul class="conversation-list">
                            @foreach (var c in conversations)
                            {
                                <li class="conversation-item @(selectedConversationId == c.ConversationId ? "selected" : "")">
                                    <div class="conv-row">
                                        <button class="link-button conv-link" @onclick="() => LoadConversation(c.ConversationId)">
                                            <div class="conv-title">@c.Title</div>
                                            <div class="conv-meta muted">@c.UpdatedAt.ToLocalTime().ToString("g")</div>
                                        </button>
                                        <div class="conv-actions">
                                            <button class="button is-small admin-action-btn" title="Delete" @onclick:stopPropagation="true" @onclick="() => DeleteConversation(c.ConversationId)">Delete</button>
                                        </div>
                                    </div>
                                </li>
                            }
                        </ul>
                    }
                </div>
            </div>

            <div class="goal-detail-area ai-chat-panel ai-chat-bg">
                <div class="ai-chat-bg-layer" aria-hidden="true"></div>
                <div class="board-header chat-header">
                    <h1 class="board-title">Eve your AI Coach</h1>
                    <p class="board-subtitle muted">Personalised career & business coaching</p>
                </div>

                <div class="chat-messages" @ref="messagesContainer">
                    @if (!log.Any())
                    {
                        <!-- Empty state intentionally blank (instruction removed) -->
                    }

                    @foreach (var l in log)
                    {
                        var isUser = l.Role == "You";
                        <div class="chat-message @(isUser ? "user" : "Eve")">
                            <div class="bubble">
                                @if (!isUser)
                                {
                                    <div class="bubble-role">Eve</div>
                                }
                                <div class="bubble-text">@((MarkupString)System.Net.WebUtility.HtmlEncode(l.Text).Replace("\n", "<br/>"))</div>
                            </div>
                        </div>
                    }
                </div>

                <div class="chat-input-bar">
                    <EditForm Model="@model" OnSubmit="Send" FormName="AIChatForm" class="chat-form">
                        <textarea @bind="model.Message"
                                  class="chat-input" id="aicoach-input"
                                  placeholder="Ask your AI coach anything…"
                                  rows="1" @onkeydown="OnInputKey"></textarea>
                        <button type="submit" class="send-btn" id="aicoach-send" disabled="@busy">
                            @(busy ? "Sending…" : "Send")
                        </button>
                    </EditForm>
                    @if (!string.IsNullOrWhiteSpace(error))
                    {
                        <div class="notification is-danger mt-2">@error</div>
                    }
                    
                </div>
            </div>
            <!-- right column removed; recent conversations moved to left aside -->
        </div>
    </div>
}

    </Authorized>
    <NotAuthorized>
        <section class="home">
            <div class="home-intro">
                <h1 class="title is-1">Eve the AI Coach</h1>
                <hr class="hr" />
                <p class="home-text">Personalised career coaching for women in tech. Please sign in to access your conversations and AI coach features.</p>
                <div class="home-buttons buttons">
                    <div class="home-buttons-shine">
                        <a class="shine" href="/signin"><span>Sign In</span></a>
                    </div>
                </div>
            </div>
        </section>
    </NotAuthorized>
</AuthorizeView>

@code {
    record Line(string Role, string Text);

    ChatRequestDTO model = new();
    List<Line> log = new();
    bool busy;
    string? error;
    private ElementReference messagesContainer;
    private List<ConversationSummaryDTO>? conversations;
    private Guid? selectedConversationId;
    private List<Dictionary<string,string>> messagesBacking = new();
    private IJSObjectReference? aicoachApiModule;

    async Task Send()
    {
        var msg = model.Message?.Trim();
        if (busy || string.IsNullOrEmpty(msg)) return;

        busy = true;
        log.Add(new("You", msg));
        model.Message = string.Empty;
        // Immediately re-render so the user's message appears while AI is processing
        await InvokeAsync(StateHasChanged);
        try { await JSRuntime.InvokeVoidAsync("import", "/js/chat.js"); await JSRuntime.InvokeVoidAsync("scrollToBottom", messagesContainer); } catch { }

        try
        {
            // record user message in backing store
            messagesBacking.Add(new Dictionary<string,string> { ["role"] = "You", ["text"] = msg });
            var reply = await Ai.GetBusinessCoachingResponse(msg);
            log.Add(new("Eve", reply));
            messagesBacking.Add(new Dictionary<string,string> { ["role"] = "Eve", ["text"] = reply });
            // after Eve reply, save conversation
            await SaveConversationIfNeeded();
        }
        catch (Exception ex)
        {
            error = $"❌ {ex.Message}";
        }
        finally
        {
            busy = false;
            // Scroll to bottom after update
            try { await JSRuntime.InvokeVoidAsync("import", "/js/chat.js"); await JSRuntime.InvokeVoidAsync("scrollToBottom", messagesContainer); } catch { }
        }
    }

    private async Task OnInputKey(KeyboardEventArgs e)
    {
        // Send on Enter key (but allow Shift+Enter for newline)
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            await Send();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // ensure container is scrolled to bottom on first render and bind Enter to send
            try {
                var chatModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "/js/chat.js");
                await chatModule.InvokeVoidAsync("scrollToBottom", messagesContainer);
            } catch { }

            // load recent conversations
            await LoadRecentConversations();
            // Using the Blazor @onkeydown handler (OnInputKey) as the single Enter handler
        }
    }

    // JS module reference (declared once)

    private async Task LoadRecentConversations()
    {
        try
        {
            if (aicoachApiModule == null) aicoachApiModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "/js/aicoach-api.js");
            var list = await aicoachApiModule.InvokeAsync<ConversationSummaryDTO[]>("fetchConversations");
            conversations = list?.ToList() ?? new List<ConversationSummaryDTO>();
            await InvokeAsync(StateHasChanged);
        }
        catch
        {
            conversations = new List<ConversationSummaryDTO>();
        }
    }

    private async Task LoadConversation(Guid id)
    {
        try
        {
            if (aicoachApiModule == null) aicoachApiModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "/js/aicoach-api.js");
            var dto = await aicoachApiModule.InvokeAsync<ConversationDetailDTO>("fetchConversation", id.ToString());
            if (dto != null)
            {
                selectedConversationId = dto.ConversationId;
                log.Clear();
                messagesBacking.Clear();
                if (!string.IsNullOrEmpty(dto.MessagesJson))
                {
                    var items = System.Text.Json.JsonSerializer.Deserialize<List<Dictionary<string,string>>>(dto.MessagesJson);
                    if (items != null)
                    {
                        foreach (var it in items)
                        {
                            var role = it.ContainsKey("role") ? it["role"] : "You";
                            var text = it.ContainsKey("text") ? it["text"] : string.Empty;
                            log.Add(new Line(role, text));
                            messagesBacking.Add(new Dictionary<string,string> { ["role"] = role, ["text"] = text });
                        }
                    }
                }
                await InvokeAsync(StateHasChanged);
            }
        }
        catch { }
    }

    private async Task DeleteConversation(Guid id)
    {
        try
        {
            if (aicoachApiModule == null) aicoachApiModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "/js/aicoach-api.js");
            var result = await aicoachApiModule.InvokeAsync<object>("deleteConversation", id.ToString());
            if (selectedConversationId == id) { selectedConversationId = null; log.Clear(); messagesBacking.Clear(); }
            await LoadRecentConversations();
        }
        catch { }
    }

    private async Task NewChat()
    {
        // Local-only: clear state, do not create or save anything until the user sends the first message
        selectedConversationId = null;
        log.Clear();
        messagesBacking.Clear();
        await InvokeAsync(StateHasChanged);
    }

    private async Task SaveConversationIfNeeded()
    {
        // Called after AI reply — serialize messagesBacking and post
        try
        {
            if (aicoachApiModule == null) aicoachApiModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "/js/aicoach-api.js");
            var title = "New Chat";
            // find first user message
            var firstUser = messagesBacking.FirstOrDefault(m => m.ContainsKey("role") && m["role"] == "You");
            if (firstUser != null && !string.IsNullOrWhiteSpace(firstUser.GetValueOrDefault("text"))) title = firstUser["text"].Length > 60 ? firstUser["text"].Substring(0,60) + "..." : firstUser["text"];
            var payloadObj = new { Title = title, MessagesJson = System.Text.Json.JsonSerializer.Serialize(messagesBacking) };
            var payload = System.Text.Json.JsonSerializer.Serialize(payloadObj);
            ConversationDetailDTO? saved = null;
            if (selectedConversationId.HasValue)
            {
                // update existing conversation
                saved = await aicoachApiModule.InvokeAsync<ConversationDetailDTO>("updateConversation", selectedConversationId.Value.ToString(), payload);
            }
            else
            {
                // create new conversation
                saved = await aicoachApiModule.InvokeAsync<ConversationDetailDTO>("postConversation", payload);
            }
            if (saved != null)
            {
                selectedConversationId = saved.ConversationId;
                await LoadRecentConversations();
            }
        }
        catch { }
    }
}
