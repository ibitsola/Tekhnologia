@page "/aicoach"
@using Microsoft.AspNetCore.Components.Forms
@using Tekhnologia.UI.Views.Shared
@using Tekhnologia.Models.DTOs
@using Tekhnologia.Services.Interfaces
@inject IAIService Ai
@inject IAuthStateService Auth
@inject IJSRuntime JSRuntime

@if (!Auth.IsLoggedIn)
{
    <RedirectToSignIn />
}
else
{
    <section class="section ai-coach-wrapper">
        <div class="ai-coach-container">
            <aside class="ai-aside">
                <div class="ai-image-container">
                    <img class="ai-img" src="images/AICoachEve.png" alt="AI coach" />
                </div>
                <div class="ai-intro">
                    <h2>Your AI Coach</h2>
                    <p>Ask career coaching questions. Clear, kind, practical guidance.</p>
                </div>
            </aside>

            <main class="ai-chat-panel box">
                <div class="chat-header">
                    <h3>AI Coach</h3>
                    <small class="muted">Personalised career & business coaching</small>
                </div>

                <div class="chat-messages" @ref="messagesContainer">
                    @if (!log.Any())
                    {
                        <div class="chat-empty">Start the conversation — ask your coach a question.</div>
                    }

                    @foreach (var l in log)
                    {
                        var isUser = l.Role == "You";
                        <div class="chat-message @(isUser ? "user" : "ai")">
                            <div class="bubble">
                                @if (!isUser)
                                {
                                    <div class="bubble-role">AI</div>
                                }
                                <div class="bubble-text">@((MarkupString)System.Net.WebUtility.HtmlEncode(l.Text).Replace("\n", "<br/>"))</div>
                            </div>
                        </div>
                    }
                </div>

                <div class="chat-input-bar">
                    <EditForm Model="@model" OnSubmit="Send" FormName="AIChatForm" class="chat-form">
                        <InputTextArea @bind-Value="model.Message"
                                       class="chat-input"
                                       placeholder="Ask your AI coach anything…"
                                       rows="1" />
                        <button type="submit" class="button is-primary send-btn" disabled="@busy">
                            @(busy ? "Sending…" : "Send")
                        </button>
                    </EditForm>
                    @if (!string.IsNullOrWhiteSpace(error))
                    {
                        <div class="notification is-danger mt-2">@error</div>
                    }
                </div>
            </main>
        </div>
    </section>
}

@code {
    record Line(string Role, string Text);

    ChatRequestDTO model = new();
    List<Line> log = new();
    bool busy;
    string? error;
    private ElementReference messagesContainer;

    async Task Send()
    {
        var msg = model.Message?.Trim();
        if (busy || string.IsNullOrEmpty(msg)) return;

        busy = true;
        log.Add(new("You", msg));
        model.Message = string.Empty;

        try
        {
            var reply = await Ai.GetBusinessCoachingResponse(msg);
            log.Add(new("AI", reply));
        }
        catch (Exception ex)
        {
            error = $"❌ {ex.Message}";
        }
        finally
        {
            busy = false;
            // Scroll to bottom after update
            try { await JSRuntime.InvokeVoidAsync("import", "/js/chat.js"); await JSRuntime.InvokeVoidAsync("scrollToBottom", messagesContainer); } catch { }
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // ensure container is scrolled to bottom on first render
            try { await JSRuntime.InvokeVoidAsync("import", "/js/chat.js"); await JSRuntime.InvokeVoidAsync("scrollToBottom", messagesContainer); } catch { }
        }
    }
}
