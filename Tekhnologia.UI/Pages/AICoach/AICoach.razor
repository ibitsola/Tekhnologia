@page "/aicoach"
@using Microsoft.AspNetCore.Components.Forms
@using Tekhnologia.UI.Views.Shared
@using Tekhnologia.Models.DTOs
@using Tekhnologia.Services.Interfaces
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Components.Web
@inject IAIService Ai
@inject IAuthStateService Auth
@inject IJSRuntime JSRuntime

@if (!Auth.IsLoggedIn)
{
    <RedirectToSignIn />
}
else
{
    <div class="goal-tracker-page">
        <div class="goal-tracker-container">
            <div class="goals-sidebar vision-board-sidebar">
                <div class="sidebar-header">
                    <h2 class="sidebar-title">My Eva</h2>
                    <button type="button" class="button is-small admin-action-btn">New Chat</button>
                </div>

                <div class="ai-intro">
                    <p>Ask career coaching questions. Clear, kind, practical guidance.</p>
                </div>

                <div class="ai-recent box">
                    <h4>Recent Conversations</h4>
                    <div class="history-empty">No conversations yet.</div>
                </div>
            </div>

            <div class="goal-detail-area ai-chat-panel ai-chat-bg">
                <div class="ai-chat-bg-layer" aria-hidden="true"></div>
                <div class="board-header chat-header">
                    <h1 class="board-title">Eva Your AI Coach</h1>
                    <p class="board-subtitle muted">Personalised career & business coaching</p>
                </div>

                <div class="chat-messages" @ref="messagesContainer">
                    @if (!log.Any())
                    {
                        <div class="chat-empty">Start the conversation with Eva.</div>
                    }

                    @foreach (var l in log)
                    {
                        var isUser = l.Role == "You";
                        <div class="chat-message @(isUser ? "user" : "ai")">
                            <div class="bubble">
                                @if (!isUser)
                                {
                                    <div class="bubble-role">AI</div>
                                }
                                <div class="bubble-text">@((MarkupString)System.Net.WebUtility.HtmlEncode(l.Text).Replace("\n", "<br/>"))</div>
                            </div>
                        </div>
                    }
                </div>

                <div class="chat-input-bar">
                    <EditForm Model="@model" OnSubmit="Send" FormName="AIChatForm" class="chat-form">
                        <textarea @bind="model.Message"
                                  class="chat-input" id="aicoach-input"
                                  placeholder="Ask your AI coach anything…"
                                  rows="1" @onkeydown="OnInputKey"></textarea>
                        <button type="submit" class="send-btn" id="aicoach-send" disabled="@busy">
                            @(busy ? "Sending…" : "Send")
                        </button>
                    </EditForm>
                    @if (!string.IsNullOrWhiteSpace(error))
                    {
                        <div class="notification is-danger mt-2">@error</div>
                    }
                </div>
            </div>
            <!-- right column removed; recent conversations moved to left aside -->
        </div>
    </div>
}

@code {
    record Line(string Role, string Text);

    ChatRequestDTO model = new();
    List<Line> log = new();
    bool busy;
    string? error;
    private ElementReference messagesContainer;

    async Task Send()
    {
        var msg = model.Message?.Trim();
        if (busy || string.IsNullOrEmpty(msg)) return;

        busy = true;
        log.Add(new("You", msg));
        model.Message = string.Empty;
        // Immediately re-render so the user's message appears while AI is processing
        await InvokeAsync(StateHasChanged);
        try { await JSRuntime.InvokeVoidAsync("import", "/js/chat.js"); await JSRuntime.InvokeVoidAsync("scrollToBottom", messagesContainer); } catch { }

        try
        {
            var reply = await Ai.GetBusinessCoachingResponse(msg);
            log.Add(new("AI", reply));
        }
        catch (Exception ex)
        {
            error = $"❌ {ex.Message}";
        }
        finally
        {
            busy = false;
            // Scroll to bottom after update
            try { await JSRuntime.InvokeVoidAsync("import", "/js/chat.js"); await JSRuntime.InvokeVoidAsync("scrollToBottom", messagesContainer); } catch { }
        }
    }

    private async Task OnInputKey(KeyboardEventArgs e)
    {
        // Send on Enter key (but allow Shift+Enter for newline)
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            await Send();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // ensure container is scrolled to bottom on first render and bind Enter to send
            try {
                var chatModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "/js/chat.js");
                await chatModule.InvokeVoidAsync("scrollToBottom", messagesContainer);
            } catch { }

            // Using the Blazor @onkeydown handler (OnInputKey) as the single Enter handler
        }
    }
}
