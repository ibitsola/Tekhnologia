@page "/journal"
@layout Views.Shared.MainLayout
@rendermode RenderMode.InteractiveServer

@using System.Security.Claims
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Tekhnologia.Services.Interfaces
@using Tekhnologia.Models.DTOs
@inject IJournalService JournalService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider

<AuthorizeView Context="authContext">
    <Authorized>
        <div class="journal-page">
            @if (loading)
            {
                <div class="section has-text-centered">
                    <p>Loading your journal...</p>
                </div>
            }
            else
            {
                <div class="journal-container">
                    <div class="journal-sidebar">
                        <div class="sidebar-header">
                            <h2 class="sidebar-title">My Journal</h2>
                            <button type="button" class="button is-small admin-action-btn" @onclick="ShowCreateModal">+ New Entry</button>
                        </div>

                        @if (!entries.Any())
                        {
                            <div class="empty-state">
                                <p>No entries yet!</p>
                                <p class="has-text-grey-light">Write your first reflection to get started.</p>
                            </div>
                        }
                        else
                        {
                            <div class="entries-list">
                                @foreach (var e in entries.OrderByDescending(x => x.CreatedAt))
                                {
                                    <div class="entry-list-item @(selectedEntry?.EntryId == e.EntryId ? "active" : "")" @onclick="() => SelectEntry(e)">
                                        <div class="entry-title">@e.Date.ToString("MMM dd")</div>
                                        <div class="entry-snippet">@((e.EntryText.Length > 80) ? e.EntryText.Substring(0, 80) + "..." : e.EntryText)</div>
                                    </div>
                                }
                            </div>
                        }
                    </div>

                    <div class="journal-detail-area">
                        @if (selectedEntry == null)
                        {
                            <div class="empty-selection">
                                <p>Select an entry to view or edit</p>
                            </div>
                        }
                        else
                        {
                            <div class="entry-detail-header">
                                <div>
                                    <h1 class="entry-date">@selectedEntry.Date.ToString("MMMM dd, yyyy")</h1>
                                </div>
                                <div class="entry-actions">
                                    <button class="button admin-action-btn" @onclick="() => ShowEditModal(selectedEntry)">Edit</button>
                                    <button class="button admin-action-btn" @onclick="() => ShowDeleteConfirm(selectedEntry)">Delete</button>
                                </div>
                            </div>

                            <div class="entry-body">
                                <p>@selectedEntry.EntryText</p>
                            </div>
                        }
                    </div>
                </div>
            }

            @if (showModal)
            {
                <div class="modal is-active">
                    <div class="modal-background" @onclick="CloseModal"></div>
                    <div class="modal-card">
                        <header class="modal-card-head">
                            <p class="modal-card-title">@(isEditMode ? "Edit Entry" : "New Journal Entry")</p>
                            <button class="delete" aria-label="close" @onclick="CloseModal"></button>
                        </header>
                        <section class="modal-card-body">
                            <EditForm Model="@entryForm" OnValidSubmit="@SaveEntry">
                                <DataAnnotationsValidator />

                                <div class="field">
                                    <label class="label">Entry</label>
                                    <div class="control">
                                        <InputTextArea class="textarea" @bind-Value="entryForm.EntryText" />
                                    </div>
                                    <ValidationMessage For="@(() => entryForm.EntryText)" />
                                </div>

                                <div class="field">
                                    <label class="label">Visibility</label>
                                    <div class="control">
                                        <label class="checkbox">
                                            <InputCheckbox @bind-Value="entryForm.Visibility" /> Public
                                        </label>
                                    </div>
                                </div>

                                <div class="field is-grouped is-grouped-right">
                                    <div class="control">
                                        <button class="button" type="button" @onclick="CloseModal">Cancel</button>
                                    </div>
                                    <div class="control">
                                        <button class="button user-role-tag" type="submit" disabled="@isSaving">@(isSaving ? "Saving..." : "Save Entry")</button>
                                    </div>
                                </div>
                            </EditForm>
                        </section>
                    </div>
                </div>
            }

            @if (showDelete && entryToDelete != null)
            {
                <div class="modal is-active">
                    <div class="modal-background" @onclick="CloseModal"></div>
                    <div class="modal-card">
                        <header class="modal-card-head">
                            <p class="modal-card-title">Confirm Delete</p>
                            <button class="delete" aria-label="close" @onclick="CloseModal"></button>
                        </header>
                        <section class="modal-card-body">
                            <p>Delete this entry from @entryToDelete.Date.ToString("MMM dd, yyyy")?</p>
                        </section>
                        <footer class="modal-card-foot">
                            <button class="button admin-action-btn" @onclick="ConfirmDelete" disabled="@isDeleting">@(isDeleting ? "Deleting..." : "Delete")</button>
                            <button class="button" @onclick="CloseModal">Cancel</button>
                        </footer>
                    </div>
                </div>
            }

            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="notification is-success notification-toast">
                    <button class="delete" @onclick="() => successMessage = null"></button>
                    @successMessage
                </div>
            }

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="notification is-danger notification-toast">
                    <button class="delete" @onclick="() => errorMessage = null"></button>
                    @errorMessage
                </div>
            }
        </div>
    </Authorized>

    <NotAuthorized>
        <section class="section has-text-centered">
            <h1 class="title is-1">Journal</h1>
            <p>Please <a href="/signin">sign in</a> to view your journal.</p>
        </section>
    </NotAuthorized>
</AuthorizeView>

@code {
    private List<JournalEntryDTO> entries = new();
    private JournalEntryDTO? selectedEntry;
    private CreateJournalEntryDTO entryForm = new();
    private JournalEntryDTO? entryToDelete;

    private string? userId;
    private string? successMessage;
    private string? errorMessage;

    private bool loading = true;
    private bool showModal = false;
    private bool showDelete = false;
    private bool isEditMode = false;
    private bool isSaving = false;
    private bool isDeleting = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            if (!authState.User.Identity?.IsAuthenticated ?? false)
            {
                return;
            }

            userId = authState.User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (string.IsNullOrEmpty(userId))
            {
                Navigation.NavigateTo("/signin");
                return;
            }

            await LoadEntries();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading journal: {ex.Message}";
        }
        finally
        {
            loading = false;
        }
    }

    private async Task LoadEntries()
    {
        if (string.IsNullOrEmpty(userId)) return;
        entries = (await JournalService.GetUserJournalEntriesAsync(userId)).ToList();
        if (entries.Any() && selectedEntry == null)
            selectedEntry = entries.First();
    }

    private void SelectEntry(JournalEntryDTO e)
    {
        selectedEntry = e;
    }

    private void ShowCreateModal()
    {
        isEditMode = false;
        entryForm = new CreateJournalEntryDTO { EntryText = string.Empty, Visibility = true, SentimentScore = null };
        showModal = true;
    }

    private void ShowEditModal(JournalEntryDTO e)
    {
        isEditMode = true;
        entryForm = new CreateJournalEntryDTO { EntryText = e.EntryText, Visibility = e.Visibility, SentimentScore = e.SentimentScore };
        selectedEntry = e;
        showModal = true;
    }

    private void ShowDeleteConfirm(JournalEntryDTO e)
    {
        entryToDelete = e;
        showDelete = true;
    }

    private async Task SaveEntry()
    {
        if (string.IsNullOrEmpty(userId)) return;
        isSaving = true;
        try
        {
            if (isEditMode && selectedEntry != null)
            {
                var (success, error, updated) = await JournalService.UpdateJournalEntryAsync(selectedEntry.EntryId, entryForm, userId);
                if (success)
                {
                    successMessage = "Entry updated";
                    await LoadEntries();
                    CloseModal();
                }
                else
                {
                    errorMessage = error;
                }
            }
            else
            {
                var created = await JournalService.CreateJournalEntryAsync(userId, entryForm);
                successMessage = "Entry created";
                await LoadEntries();
                CloseModal();
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task ConfirmDelete()
    {
        if (entryToDelete == null || string.IsNullOrEmpty(userId)) return;
        isDeleting = true;
        try
        {
            var (success, error) = await JournalService.DeleteJournalEntryAsync(entryToDelete.EntryId, userId);
            if (success)
            {
                successMessage = "Entry deleted";
                await LoadEntries();
                CloseModal();
            }
            else
            {
                errorMessage = error;
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isDeleting = false;
        }
    }

    private void CloseModal()
    {
        showModal = false;
        showDelete = false;
        entryToDelete = null;
    }
}

@code {
    private void NavigateToSignup() =>
        Navigation.NavigateTo("/signup");
}
