@page "/profile"
@layout Views.Shared.MainLayout

@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization          
@using Microsoft.AspNetCore.Components.Forms
@using Tekhnologia.UI.Views.Shared
@using Tekhnologia.Services.Interfaces
@inject IAuthStateService AuthState
@inject NavigationManager NavManager
@inject IUserService UserService
@inject AuthenticationStateProvider AuthStateProvider
@inject HttpClient Http


@if (!authChecked || loading)
{
    <div class="section has-text-centered">
        <p>Loading your informationâ€¦</p>
    </div>
}
else if (!AuthState.IsLoggedIn)
{
    <RedirectToSignIn />
}
else if (loadError != null)
{
    <div class="notification is-danger">@loadError</div>
}
else if (user == null)
{
    <div class="notification is-warning">
        We couldn't find your profile. Please <a href="/signin">sign in</a> again.
    </div>
}
else
{
    <div class="auth-container">
        <div class="auth-box">
            <h2 class="auth-heading">Your Profile</h2>

            <div class="field">
                <label class="label">Name</label>
                <p>@(user.Name ?? string.Empty)</p>
            </div>

            <div class="field">
                <label class="label">Email</label>
                <p>@(user.Email ?? string.Empty)</p>
            </div>

            <div class="field">
                <label class="label">Joined</label>
                <p>@user.CreatedAt.ToLocalTime().ToString("f")</p>
            </div>

            <div class="field is-grouped is-grouped-centered" style="margin-top:1.5rem;">
                <p class="control">
                    <a href="/profile/edit" class="button is-primary">Edit</a>
                </p>
                <p class="control">
                    <a href="/profile/delete" class="button is-danger">Delete</a>
                </p>
            </div>
        </div>
    </div>
}

@code {
    private Tekhnologia.Models.User? user;
    private bool loading = true;
    private string? loadError;
    private bool authChecked = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Ensure auth state is initialized
            await AuthState.CheckAuthStatus();
            authChecked = true;

            if (!AuthState.IsLoggedIn)
            {
                loading = false;
                StateHasChanged();
                return;
            }

            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var id = authState.User.FindFirstValue(ClaimTypes.NameIdentifier);

            if (string.IsNullOrEmpty(id))
            {
                loadError = "Unable to determine your user ID. Please sign in again.";
                loading = false;
                StateHasChanged();
                return;
            }

            user = await UserService.GetUserProfileAsync(id);
            
            if (user == null)
                loadError = "Profile not found.";
        }
        catch (Exception ex)
        {
            loadError = $"Error loading profile: {ex.Message}";
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }

    private void EditProfile()
    {
        Console.WriteLine("Edit button clicked - navigating to /profile/edit");
        NavManager.NavigateTo("/profile/edit", forceLoad: true);
    }

    private void DeleteProfile()
    {
        Console.WriteLine("Delete button clicked - navigating to /profile/delete");
        NavManager.NavigateTo("/profile/delete");
    }
}
