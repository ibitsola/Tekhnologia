@page "/signup"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Forms
@using Tekhnologia.UI.Services.Interfaces
@inject IAuthApiService AuthApi
@inject IAuthStateService AuthState
@inject NavigationManager Nav

<h3 class="auth-heading">Sign Up</h3>

<EditForm Model="model" OnValidSubmit="HandleSubmit" class="auth-container">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <div class="auth-box">
        <div class="field">
            <label class="label" for="name">Name</label>
            <InputText id="name" class="input" @bind-Value="model.Name" />
            <ValidationMessage For="(()=>model.Name)" />
        </div>
        <div class="field">
            <label class="label" for="email">Email</label>
            <InputText id="email" class="input" @bind-Value="model.Email" />
            <ValidationMessage For="(()=>model.Email)" />
        </div>
        <div class="field">
            <label class="label" for="password">Password</label>
            <InputText id="password" type="password" class="input" @bind-Value="model.Password" />
            <ValidationMessage For="(()=>model.Password)" />
        </div>
        <div class="field">
            <label class="label" for="confirm">Confirm Password</label>
            <InputText id="confirm" type="password" class="input" @bind-Value="model.ConfirmPassword" />
            <ValidationMessage For="(()=>model.ConfirmPassword)" />
        </div>
        <button type="submit" class="button signup-button" disabled="@busy">@(busy?"Signing Up...":"Sign Up")</button>
    </div>
    @if (!string.IsNullOrEmpty(error))
    {
        <div class="notification is-danger">@error</div>
    }
    @if (!string.IsNullOrEmpty(success))
    {
        <div class="notification is-success">@success</div>
    }
    <div class="already-member">
        <p>Already have an account?</p>
        <a href="/signin" class="button is-primary auth-button">Log In</a>
    </div>
</EditForm>

@code {
    private readonly SignUpModel model = new();
    private bool busy;
    private string? error;
    private string? success;

    private async Task HandleSubmit()
    {
        busy = true; error = success = null;
        var (ok, errs) = await AuthApi.RegisterAsync(new RegisterRequest
        {
            Name = model.Name,
            Email = model.Email,
            Password = model.Password,
            ConfirmPassword = model.ConfirmPassword
        });
        if (ok)
        {
            // Auto-login
            var loginOk = await AuthState.LoginAsync(model.Email!, model.Password!);
            if (loginOk)
            {
                success = "Account created successfully! Redirecting...";
                await Task.Delay(800);
                Nav.NavigateTo("/profile", true);
            }
            else
            {
                success = "Registered. Please sign in.";
            }
        }
        else
        {
            error = string.Join("; ", errs);
        }
        busy = false;
    }

    private sealed class SignUpModel
    {
        [Required, StringLength(100)]
        public string? Name { get; set; }
        [Required, EmailAddress]
        public string? Email { get; set; }
        [Required, MinLength(8)]
        public string? Password { get; set; }
        [Required, Compare(nameof(Password), ErrorMessage="Passwords do not match")] 
        public string? ConfirmPassword { get; set; }
    }
}