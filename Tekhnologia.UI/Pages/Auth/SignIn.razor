@page "/signin"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Forms
@using Tekhnologia.UI.Services.Interfaces
@inject IAuthStateService AuthState
@inject NavigationManager Nav

<h3 class="auth-heading">Sign In</h3>

@if (!AuthState.Initialized)
{
    <p>Checking authentication...</p>
}
else if (AuthState.IsLoggedIn)
{
    <p>✅ You are logged in — redirecting...</p>
}
else
{
    <EditForm Model="model" OnValidSubmit="HandleSignIn" class="auth-container">
        <DataAnnotationsValidator />
        <ValidationSummary />
        <div class="auth-box">
            <div class="field">
                <label class="label" for="email">Email</label>
                <InputText id="email" class="input" @bind-Value="model.Email" />
                <ValidationMessage For="(()=>model.Email)" />
            </div>
            <div class="field">
                <label class="label" for="password">Password</label>
                <InputText id="password" type="password" class="input" @bind-Value="model.Password" />
                <ValidationMessage For="(()=>model.Password)" />
            </div>
            <button type="submit" class="button auth-button" disabled="@busy">@(busy?"Signing In...":"Sign In")</button>
        </div>
        @if (!string.IsNullOrEmpty(error))
        {
            <div class="notification is-danger">@error</div>
        }
        <div class="already-member">
            <p>Don't have an account?</p>
            <a href="/signup" class="button is-primary auth-button">Sign Up</a>
        </div>
    </EditForm>
}

@code {
    private readonly SignInModel model = new();
    private bool busy;
    private string? error;

    protected override async Task OnInitializedAsync()
    {
        if (!AuthState.Initialized)
            await AuthState.RefreshAsync();
        if (AuthState.IsLoggedIn)
            Nav.NavigateTo("/profile", true);
    }

    private async Task HandleSignIn()
    {
        busy = true; error = null;
        var success = await AuthState.LoginAsync(model.Email!, model.Password!);
        if (success)
        {
            Nav.NavigateTo("/profile", forceLoad:true);
        }
        else
        {
            error = "Invalid credentials"; // backend returns text; could enhance parsing later
        }
        busy = false;
    }

    private sealed class SignInModel
    {
        [Required, EmailAddress]
        public string? Email { get; set; }
        [Required]
        public string? Password { get; set; }
    }
}